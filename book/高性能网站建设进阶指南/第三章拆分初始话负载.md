# 第三章 拆分初始话负载

## 3.1 全部加载
初始化时，只加载必要的js，其余的js稍后加载。<br>
<b>一些问题：</b>

+ 能节省多少时间？
+ 如何找到需要拆分的代码？
+ 如何处理竞争状态？
+ 如何延迟加载其余部分代码？

## 3.2 通过拆分来节省下载量
大部分JS代码可以在onload之后延迟下载。

## 3.3 寻找拆分
可以用firebug性能分析器显示onload之前所执行的函数名，但是不能简单的以此为依据进行剥离，如：一些错误处理和条件判断代码。<br>
Doloto微软研究院开发自动拆分js的代码系统，可以进行分组。<br>
最佳实践建议将onload之前执行的代码放到一个文件中，剩下的代码之后采取无阻塞下载技术下载。
## 3.4 未定义标识符和竞争状态
拆分JS代码的一个难点是要避免出现未定义标识符错误。<br>
在延迟加载JS和用户代码操作之间建立竞争状态。<br>
在延迟加载代码与用户界面元素相关联的情况下的解决方案：

1. 改变元素展现。（如：加载中...）
2. 用addEventListener和attachEvent在延迟加载的代码里绑定界面元素。

在延迟加载代码与用户界面元素不关联的情况下，可以使用桩(stub)函数。（与原函数函数名相同，但是函数体为空，或用临时代码代替）<br>
Doloto的方案：初始化下载插入桩函数，调用时动态加载JS代码，下载完成后覆盖桩函数。<br>
更简单的作法：再桩函数里返回一个桩值，在下载完成前用户使用相关DHTML时，没有任何反应。桩值记录用户请求，并在下载完成时，调用相应的代码。<br>
<br>
拆分CSS也是有益的，但资源节省的要少一些。

1. CSS文件大小小于JS。
2. 下载CSS文件不会有阻塞效果。

